# 批量视频换脸工具使用说明

## 📋 功能特点

基于 iRoopDeepFaceCam 项目开发的批量视频换脸工具，完全支持截图中显示的所有功能：

### ✨ 核心功能
- **Face Enhancer**: 人脸增强，提升换脸效果质量
- **Keep fps**: 保持原始视频帧率
- **Keep Audio**: 保持原始音频
- **Keep Frames**: 可选择保留临时帧文件
- **Face Tracking**: 智能人脸跟踪
- **Mouth Mask**: 嘴部遮罩处理
- **智能系统监控**: 实时监控CPU温度、内存和CPU使用率
- **散热安全检查**: 开始前强制确认笔记本散热状况
- **智能等待机制**: 系统过热或负载过高时自动等待至安全状态
- **自动内存管理**: 每个视频完成后自动清理内存并休息

### 🎯 批量处理特性
- 递归搜索子目录中的视频文件
- 支持多种视频格式 (MP4, AVI, MKV, MOV, WMV, FLV)
- 保持原有目录结构
- **智能排序**: 按文件名数字从大到小处理（如：5.0万 → 3.2万 → 1.8万）
- 详细的处理进度显示
- 完整的错误处理和统计

## 🚀 使用方法

### 🎯 交互模式（推荐）
直接运行脚本进入交互模式：
```bash
python batch_face_swap.py
```

交互模式会分3步引导您完成配置：
1. **第一步**：选择源人脸图片（用于换脸的图片）
2. **第二步**：选择待换脸的视频目录
3. **第三步**：自动创建输出目录（在输入目录下创建 `目录名-swapped-iroop` 子目录）

### 📝 命令行模式
如果您熟悉命令行参数，也可以直接使用：
```bash
python batch_face_swap.py -s <源人脸图片> -i <输入视频目录> -o <输出目录>
```

### 📝 参数说明

#### 必需参数
- `-s, --source`: 源人脸图片路径 (JPG, PNG格式)
- `-i, --input`: 输入视频文件夹路径
- `-o, --output`: 输出视频文件夹路径

#### 可选参数
- `--no-recursive`: 不递归搜索子目录
- `--no-audio`: 不保持原始音频
- `--no-fps`: 不保持原始FPS，使用30fps
- `--no-enhancer`: 禁用Face Enhancer功能
- `--keep-frames`: 保留临时帧文件用于调试
- `--video-quality [0-51]`: 设置视频质量 (默认18，越小质量越高)
- `--rest-time [秒数]`: 设置每个视频完成后的休息时间 (默认180秒即3分钟)
- `--no-auto-clean`: 禁用自动内存清理和休息功能

## 💡 使用示例

### 🎭 交互模式示例
```bash
# 启动交互模式
python batch_face_swap.py

# 程序会提示您：
# 📷 第一步：选择源人脸图片
# 请输入源人脸图片路径 (支持 JPG, PNG 格式): my_face.jpg
# ✅ 源图片已选择: my_face.jpg

# 📁 第二步：选择待换脸的视频目录  
# 请输入视频目录路径: /Users/caoxinnan/repo/douyin-downloader/downloads/ciu7
# ✅ 视频目录已选择: /Users/caoxinnan/repo/douyin-downloader/downloads/ciu7
# 📹 找到 5 个视频文件

# 💾 第三步：自动设置输出目录
# ✅ 输出目录已自动创建: /Users/caoxinnan/repo/douyin-downloader/downloads/ciu7/ciu7-swapped-iroop

# 📋 配置确认:
# 📷 源图片: my_face.jpg
# 📁 输入目录: /Users/caoxinnan/repo/douyin-downloader/downloads/ciu7
# 💾 输出目录: /Users/caoxinnan/repo/douyin-downloader/downloads/ciu7/ciu7-swapped-iroop
# 🏷️  输出格式: xxx-swapped-iroop.mp4

# 是否开始批量处理？(y/n): y
```

### 📝 命令行模式示例

#### 1. 基本批量处理
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/
```

#### 2. 不递归搜索子目录
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/ --no-recursive
```

#### 3. 自定义设置
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/ --no-audio --video-quality 15
```

#### 4. 禁用Face Enhancer (提高处理速度)
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/ --no-enhancer
```

#### 5. 自定义休息时间 (适合长时间批量处理)
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/ --rest-time 300
```

#### 6. 禁用自动清理 (快速处理模式)
```bash
python batch_face_swap.py -s source_face.jpg -i input_videos/ -o output_videos/ --no-auto-clean
```

## 📁 目录结构示例

### 输入结构（支持数字排序）
```
input_videos/
├── 5.2万-热门视频.mp4
├── 3.8万-搞笑集锦.mp4
├── 1.0万-吃饭#宝宝辅食.mp4
├── 8500-日常生活.mp4
├── subfolder1/
│   ├── 2.1万-旅游vlog.mp4
│   └── 950-测试视频.mkv
└── subfolder2/
    └── 4.6万-音乐MV.mov
```

### 处理顺序（按数字从大到小）
```
📊 视频文件按数字排序结果（从大到小）：
   1. 5.2万-热门视频.mp4 (数值: 52,000)
   2. 4.6万-音乐MV.mov (数值: 46,000)  
   3. 3.8万-搞笑集锦.mp4 (数值: 38,000)
   4. 2.1万-旅游vlog.mp4 (数值: 21,000)
   5. 1.0万-吃饭#宝宝辅食.mp4 (数值: 10,000)
   6. 8500-日常生活.mp4 (数值: 8,500)
   7. 950-测试视频.mkv (数值: 950)
```

### 输出结构（自动在输入目录内创建子目录）
```
/Users/caoxinnan/repo/douyin-downloader/downloads/ciu7/
├── 5.2万-热门视频.mp4              # 原始视频
├── 3.8万-搞笑集锦.mp4
├── 1.0万-吃饭#宝宝辅食.mp4
├── 8500-日常生活.mp4
└── ciu7-swapped-iroop/             # 自动创建的输出目录
    ├── 5.2万-热门视频-swapped-iroop.mp4
    ├── 3.8万-搞笑集锦-swapped-iroop.mp4
    ├── 1.0万-吃饭#宝宝辅食-swapped-iroop.mp4
    └── 8500-日常生活-swapped-iroop.mp4
```

## ⚙️ 配置说明

工具默认使用以下配置（基于截图设置）：

```python
# 基本功能
✅ Face Enhancer: 开启
✅ Keep fps: 保持原始帧率
✅ Keep Audio: 保持原始音频
✅ Face Tracking: 智能人脸跟踪
✅ Mouth Mask: 嘴部遮罩处理

# 高级参数
- 视频编码器: libx264
- 视频质量: 18 (高质量)
- 嵌入权重: 0.60
- 位置权重: 0.40
- 旧权重: 0.90 / 新权重: 0.10
```

## 🔧 系统要求

### 环境依赖
- Python 3.9+
- ffmpeg (用于视频处理)
- 项目所需的所有依赖包

### 硬件建议
- **CPU**: 多核处理器 (建议8线程以上)
- **内存**: 
  - macOS: 4GB+ 可用内存
  - Windows/Linux: 16GB+ 可用内存
- **存储**: 足够的临时空间 (视频大小的2-3倍)

## 🔥 系统监控与散热管理

### 🌡️ 智能温度监控
工具会实时监控系统温度和负载，确保设备安全运行：

**监控指标**：
- **CPU温度**: 自动检测CPU温度（需要sudo权限）
- **内存使用率**: 实时监控内存占用
- **CPU使用率**: 监控处理器负载

**安全阈值**（可自定义）：
- CPU温度: 75°C（超过时等待，降至65°C以下继续）
- 内存使用率: 85%（超过时等待，降至70%以下继续）
- CPU使用率: 90%（超过时等待，降至60%以下继续）

### 💻 散热安全提醒
程序启动时会强制进行散热检查：
```
🔥 重要提醒：散热检查
============================================================
📱 为了确保系统安全运行，请确保：
   1. 笔记本盖子已经完全打开
   2. 散热风扇可以正常运行
   3. 通风口没有被遮挡
   4. 周围环境通风良好

❓ 请确认笔记本盖子已打开并散热良好 (输入 'yes' 继续):
```

### ⏰ 智能等待机制
当系统温度或负载过高时：
```
⚠️  系统状态需要等待:
   🔥 CPU温度过高: 78.5°C (阈值: 75.0°C)
   💾 内存使用率过高: 87.2% (阈值: 85.0%)
🕒 等待 30 秒后重新检查...
```

每个任务完成后都会进行安全检查：
```
🔍 检查系统状态...
📊 系统状态 - 温度: 63.2°C | CPU: 45.6% | 内存: 68.9%
✅ 系统状态正常
```

### 🛠️ 自定义监控参数
```bash
# 调整温度阈值（在代码中修改）
self.temp_threshold = 80.0    # 提高到80度
self.temp_safe = 70.0         # 降至70度继续

# 调整监控间隔
self.monitor_interval = 60    # 改为60秒检查一次
```

## 📊 处理流程

1. **散热安全检查**: 强制确认笔记本散热状况
2. **验证输入**: 检查源图片和输入目录
3. **搜索视频**: 递归查找所有支持的视频文件，按数字从大到小排序
4. **系统预检**: 检查内存使用率，必要时预先清理
5. **逐个处理**: 无需人工干预的视频处理
   - 🎯 自动处理每个视频文件
   - 🔄 处理完成后进行系统监控
   - 🔍 检查CPU温度、内存、CPU使用率
   - ⏰ 如超过阈值则等待至安全范围
6. **任务间维护**: 自动内存清理和系统休息
7. **统计报告**: 显示处理成功/失败数量和最终系统状态

## ⚠️ 注意事项

### 系统要求和内存管理
- **推荐使用启动脚本**: `./run_batch_macos.sh` 确保正确的环境
- **完全无人值守**: 内置密码自动化，整个过程无需手动输入密码
- **智能系统监控**: 每个任务完成后自动检查系统状态，过热时自动等待
- **适合夜间处理**: 长时间批量处理建议在夜间进行，温度更低
- **16GB内存充足**: 配合自动清理功能，16GB内存完全满足需求

### 性能优化
- 大量视频处理时建议分批进行
- 可以通过 `--no-enhancer` 提高处理速度
- 确保有足够的磁盘空间存储临时文件
- 使用 `--rest-time` 调整休息时间，默认3分钟适合大多数情况

### 错误处理
- 处理失败的视频会被跳过，不影响其他文件
- 详细的错误信息会显示在控制台
- 临时文件会自动清理

### 文件安全
- 原始视频文件不会被修改
- 输出文件会覆盖同名文件，请注意备份

## 🐛 常见问题

### Q: 提示"ffmpeg未安装"
A: 请安装ffmpeg并确保在系统PATH中

### Q: 内存不足错误
A: 减少并发处理或降低视频质量设置

### Q: 处理速度很慢
A: 可以使用 `--no-enhancer` 参数禁用Face Enhancer功能

### Q: 音频不同步
A: 确保使用 `--keep-fps` 参数保持原始帧率

## 📈 效果对比

| 功能 | 效果 | 性能影响 |
|------|------|----------|
| Face Enhancer | 显著提升人脸质量 | 处理时间增加50% |
| Keep fps | 保持流畅度 | 无影响 |
| Keep Audio | 保持音视频同步 | 轻微增加 |
| Face Tracking | 提高稳定性 | 轻微增加 |

## 🧠 自动内存管理功能

### 内存监控机制
工具会自动监控系统内存使用率：
- **健康状态**: < 75% 内存使用率
- **警告状态**: 75-85% 内存使用率
- **危险状态**: > 85% 内存使用率

### 自动清理流程
每个视频处理完成后，工具会自动执行：

1. **内存检查**: 显示当前内存使用率
2. **执行清理**: 运行 `sudo purge` 命令
3. **效果验证**: 显示清理后的内存使用率
4. **系统休息**: 倒计时休息指定时间（默认3分钟）

### 清理效果示例
```
💤 系统休息 180 秒...
📊 休息前内存使用率: 78.5%
🧹 正在清理系统内存...
✅ 内存清理完成
📊 清理后内存使用率: 45.2% (释放了 33.3%)
⏰ 还有 180 秒继续下一个任务...
⏰ 还有 150 秒继续下一个任务...
⏰ 还有 120 秒继续下一个任务...
🚀 休息完成，继续处理...
```

### 适用场景
- **夜间批量处理**: 479个视频自动处理，无需人工干预
- **内存有限环境**: 16GB内存配合自动清理，效果等同32GB
- **温度控制**: 定期休息避免M1芯片过热
- **稳定性保证**: 每个任务后清理，避免内存泄漏累积

### 自定义配置
```bash
# 设置休息时间为5分钟
./run_batch_macos.sh --rest-time 300

# 快速模式，禁用自动清理
./run_batch_macos.sh --no-auto-clean

# 只处理前10个视频（测试用）
# 手动停止程序即可
```

---

**注**: 本工具基于截图中的配置优化，确保与原项目GUI版本的效果一致。结合最佳实践指南的内存管理策略，实现了真正的无人值守批量处理。 